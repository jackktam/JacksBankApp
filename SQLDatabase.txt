CREATE TABLE USERS (
    USERID NUMBER(8,0) PRIMARY KEY,
    USERNAME VARCHAR2(20) UNIQUE,
    PASS VARCHAR2(20) NOT NULL,
    TYPEID NUMBER(1,0) NOT NULL
);

CREATE TABLE ACCOUNTS(
    ACCOUNTID NUMBER(8,0) PRIMARY KEY,
    BALANCE NUMBER(10,2) CHECK (BALANCE > 0)
);


ALTER TABLE ACCOUNTS ADD CONSTRAINT OVERDRAW CHECK (BALANCE>=0);

CREATE TABLE APP(
    APPID NUMBER(8,0),
    USERNAME VARCHAR2(20),
    PRIMARY KEY (APPID, USERNAME),
    FOREIGN KEY (USERNAME) REFERENCES USERS(USERNAME)
);


CREATE TABLE ACCOUNTTYPE (
    TYPEID NUMBER(1,0) UNIQUE,
    TYPENAME VARCHAR2(10)
);
    

CREATE TABLE CUSTOMERACCOUNT(
    USERNAME VARCHAR2(20),
    ACCOUNTID NUMBER(8,0),
    PRIMARY KEY(USERNAME, ACCOUNTID),
    FOREIGN KEY (USERNAME) REFERENCES USERS(USERNAME),
    FOREIGN KEY (ACCOUNTID) REFERENCES ACCOUNTS(ACCOUNTID)
);


CREATE SEQUENCE A_ID_SEQ
    MINVALUE 1
    MAXVALUE 99999999
    START WITH 1
    INCREMENT BY 1
    CACHE 5
;

CREATE SEQUENCE C_ID_SEQ
    MINVALUE 1
    MAXVALUE 99999999
    START WITH 3
    INCREMENT BY 1
    CACHE 5
;


CREATE SEQUENCE APP_ID_SEQ
    MINVALUE 1
    MAXVALUE 99999999
    START WITH 1
    INCREMENT BY 1
    CACHE 5
;

INSERT INTO USERS(USERID, USERNAME, PASS, TYPEID) VALUES(1, 'admin', 'admin', 3);

INSERT INTO USERS(USERID, USERNAME, PASS, TYPEID) VALUES(2, 'employee', 'employee', 2);


CREATE TABLE LOGS(
    LOGID NUMBER,
    TRANSACTIONTIME TIMESTAMP,
    ACCOUNTID NUMBER,
    OLDBALANCE NUMBER,
    NEWBALANCE NUMBER
);

CREATE OR REPLACE TRIGGER LOG_ACCOUNT_UPDATES 
    AFTER UPDATE OF BALANCE ON ACCOUNTS 
    FOR EACH ROW
    BEGIN
        INSERT INTO LOGS(LOGID, TRANSACTIONTIME, ACCOUNTID, OLDBALANCE, NEWBALANCE)
        VALUES(LOG_ID_SEQ.NEXTVAL, SYSTIMESTAMP, :OLD.ACCOUNTID, :OLD.BALANCE, :NEW.BALANCE);
    END;
/

CREATE SEQUENCE LOG_ID_SEQ
    MINVALUE 1
    MAXVALUE 99999999
    START WITH 1
    INCREMENT BY 1
    CACHE 5
;

CREATE OR REPLACE PROCEDURE DELETEACCOUNT(
    AID NUMBER)
    AS BEGIN 
        DELETE FROM CUSTOMERACCOUNT WHERE ACCOUNTID = AID;
        DELETE FROM LOGS WHERE ACCOUNTID = AID ;
        DELETE FROM ACCOUNTS WHERE ACCOUNTID = AID;
    END;
/